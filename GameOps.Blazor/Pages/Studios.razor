@page "/studios"
@using GameOps.Contracts.Studios
@inject HttpClient Http
@inject NavigationManager Nav

<div class="studios-container">
    <div class="header">
        <h1>Studios</h1>
        <p class="subtitle">Your Library:</p>
    </div>

    @if (studios == null)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading studios...</p>
        </div>
    }
    else if (!studios.Any())
    {
        <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
            <h2>No Studios Available</h2>
            <p>No Studios available to Show</p>
        </div>
    }
    else
    {
        <div class="studios-grid">
            @foreach (var studio in studios)
            {
                <div class="studio-card">
                    <div class="card-image">
                        <img src="@GetStudioImage(studio.Id)" alt="@studio.Name" />
                    </div>
                    <div class="card-content">
                        <h3 class="studio-name">@studio.Name</h3>
                        <p class="studio-date">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Created at: @studio.CreatedAt.ToString("dd/MM/yyyy")
                        </p>
                        <button class="btn-details" @onclick="() => GoToDetails(studio.Id)">
                            View Games
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7" />
                            </svg>
                        </button>
                        <button class="btn-edit" @onclick="() => ShowEditModal(studio)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Edit
                        </button>
                        <button class="btn-delete" @onclick="() => ShowDeleteConfirm(studio)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>                
            }
            <div class="studio-card add-card" @onclick="ShowAddStudioModal">
                <div class="add-card-content">
                    <div class="add-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                    </div>
                    <h3>Add New Studio</h3>
                    <p>Create a new game studio</p>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal to add studio -->
@if (showModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Create New Studio</h2>
                <button class="close-btn" @onclick="CloseModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="studioName">Studio Name</label>
                    <input type="text" id="studioName" @bind="newStudioName" placeholder="Enter studio name" />
                </div>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">@errorMessage</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseModal">Cancel</button>
                <button class="btn-save" @onclick="CreateStudio" disabled="@isCreating">
                    @if (isCreating)
                    {
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>Create Studio</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<!-- Modal to edit studio -->
@if (showEditModal && studioToEdit != null)
{
    <div class="modal-overlay" @onclick="CloseEditModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Edit Studio</h2>
                <button class="close-btn" @onclick="CloseEditModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editStudioName">Studio Name</label>
                    <input type="text" id="editStudioName" @bind="editStudioName" placeholder="Enter studio name" />
                </div>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">@errorMessage</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseEditModal">Cancel</button>
                <button class="btn-save" @onclick="UpdateStudio" disabled="@isUpdating">
                    @if (isUpdating)
                    {
                        <span>Updating...</span>
                    }
                    else
                    {
                        <span>Update Studio</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<!-- Modal to confirm delete -->
@if (showDeleteModal && studioToDelete != null)
{
    <div class="modal-overlay" @onclick="CloseDeleteModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Delete Studio</h2>
                <button class="close-btn" @onclick="CloseDeleteModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="warning-content">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#e53e3e" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <p>Are you sure you want to delete <strong>@studioToDelete.Name</strong>?</p>
                    <p class="warning-text">This action cannot be undone.</p>
                </div>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">@errorMessage</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseDeleteModal">Cancel</button>
                <button class="btn-delete-confirm" @onclick="DeleteStudio" disabled="@isDeleting">
                    @if (isDeleting)
                    {
                        <span>Deleting...</span>
                    }
                    else
                    {
                        <span>Delete Studio</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<StudioDto>? studios;

    // Add modal
    private bool showModal = false;
    private string newStudioName = "";
    private bool isCreating = false;

    // Edit modal
    private bool showEditModal = false;
    private StudioDto? studioToEdit = null;
    private string editStudioName = "";
    private bool isUpdating = false;

    // Delete modal
    private bool showDeleteModal = false;
    private StudioDto? studioToDelete = null;
    private bool isDeleting = false;

    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadStudios();
    }

    async Task LoadStudios()
    {
        studios = await Http.GetFromJsonAsync<List<StudioDto>>("api/studios");
    }

    void GoToDetails(Guid id)
    {
        Nav.NavigateTo($"/studios/{id}");
    }

    string GetStudioImage(Guid studioId)
    {
        return $"https://ui-avatars.com/api/?name=Studio&size=400&background=667eea&color=fff";
    }

    // Add studio methods
    void ShowAddStudioModal()
    {
        showModal = true;
        newStudioName = "";
        errorMessage = "";
    }

    void CloseModal()
    {
        showModal = false;
        newStudioName = "";
        errorMessage = "";
    }

    async Task CreateStudio()
    {
        if (string.IsNullOrWhiteSpace(newStudioName))
        {
            errorMessage = "Studio name is required";
            return;
        }

        isCreating = true;
        errorMessage = "";

        try
        {
            var response = await Http.PostAsJsonAsync("api/studios", new { Name = newStudioName });

            if (response.IsSuccessStatusCode)
            {
                CloseModal();
                await LoadStudios();
            }
            else
            {
                errorMessage = "Failed to create studio. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isCreating = false;
        }
    }

    // Edit studio methods
    void ShowEditModal(StudioDto studio)
    {
        studioToEdit = studio;
        editStudioName = studio.Name;
        showEditModal = true;
        errorMessage = "";
    }

    void CloseEditModal()
    {
        showEditModal = false;
        studioToEdit = null;
        editStudioName = "";
        errorMessage = "";
    }

    async Task UpdateStudio()
    {
        if (studioToEdit == null) return;

        if (string.IsNullOrWhiteSpace(editStudioName))
        {
            errorMessage = "Studio name is required";
            return;
        }

        isUpdating = true;
        errorMessage = "";

        try
        {
            var response = await Http.PatchAsJsonAsync($"api/studios/{studioToEdit.Id}", new { Name = editStudioName });

            if (response.IsSuccessStatusCode)
            {
                CloseEditModal();
                await LoadStudios();
            }
            else
            {
                errorMessage = "Failed to update studio. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isUpdating = false;
        }
    }

    // Delete studio methods
    void ShowDeleteConfirm(StudioDto studio)
    {
        studioToDelete = studio;
        showDeleteModal = true;
        errorMessage = "";
    }

    void CloseDeleteModal()
    {
        showDeleteModal = false;
        studioToDelete = null;
        errorMessage = "";
    }

    async Task DeleteStudio()
    {
        if (studioToDelete == null) return;

        isDeleting = true;
        errorMessage = "";

        try
        {
            var response = await Http.DeleteAsync($"api/studios/{studioToDelete.Id}");

            if (response.IsSuccessStatusCode)
            {
                CloseDeleteModal();
                await LoadStudios();
            }
            else
            {
                errorMessage = "Failed to delete studio. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }
}
